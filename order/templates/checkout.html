{% extends "base.html" %}

{% block title_content %}
  <title>Finalizar Compra — Mercadinho X</title>
{% endblock title_content %}

{% block content %}
  <style>
    main {
      max-width: 100%;
      margin: 60px auto;
      padding: 0 32px;
      display: flex;
      flex-direction: column;
    }

    .main-div {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 40px;
    }
    h1 {
      grid-column: 1 / -1;
      text-align: center;
      font-size: 32px;
      margin-bottom: 20px;
      font-weight: 700;
    }
    
    .order-summary {
      background: #fff;
      padding: 32px;
      height: 60vh;
      overflow-y: auto;
      margin-bottom: 12px;
      padding-right: 8px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .order-address {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      background: #fff;
      padding: 32px;
      height: 60vh;
      margin-bottom: 12px;
      padding-right: 8px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }


    h2 {
      font-size: 20px;
      margin-bottom: 16px;
      font-weight: 600;
    }

    label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: var(--muted);
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 16px;
      border-radius: 8px;
      border: 1px solid #d1d5db;
      font-family: inherit;
      font-size: 15px;
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(46, 139, 58, 0.2);
    }

    .table_itens table {
      border-collapse: collapse;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table_itens th, td {
      padding: 16px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }

    .table_itens th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .table_itens tr:last-child td {
      border-bottom: none;
    }

    .table_itens img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      border-radius: 8px;
    }
    .order-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .order-item span {
      font-weight: 500;
    }

    .order-total {
      align-items: center;
      padding-top: 12px;
      font-weight: 700;
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      font-size: 18px;
    }
    
    .confirm-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 14px 22px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: opacity 0.2s ease;
      max-width: 30%;
    }

    .confirm-btn:hover {
      opacity: 0.9;
    }
    
    .address-option {
    display: flex;
    align-items: start;
    gap: 12px;

    padding: 12px;
    margin-bottom: 10px;

    cursor: pointer;
    }

    .address-option:hover {
        background-color: #f9f9f9;
    }

    .address-option input[type="radio"] {
        transform: scale(1.2);
    }

    .address-info {
        line-height: 1.4;
    }


  </style>
  <main>
    <h1>Finalizar Compra</h1>

    <div class="main-div">
      {% if cart and cart.itens.exists %}   <!-- Caso exista um carrinho com itens  -->
        <!-- FORMULÁRIO DE ENDEREÇO -->
        {% if addresses %}
          <form method="post" >
            {% csrf_token %}
            <div class="order-address">
              <div>
                <h2>Endereço de Entrega</h2>
  
                  {% for radio in form.address %}
                    <label class="address-option">
                        <span class="radio">
                            {{ radio.tag }}
                        </span>
  
                        <span class="address-info">
                            <strong>{{ radio.choice_label }}</strong>
                        </span>
                    </label>
                    {% endfor %}
    
                    {% if form.address.errors %}
                        <div class="error">{{ form.address.errors }}</div>
                    {% endif %}
              </div>
              <div>

                <div class="order-total">
                  <div style="justify-content: space-between;">
                    <h2>Forma de Pagamento</h2>
                    {{ form.payment_method }}
                  </div>
                  <div style="display: flex; justify-content: center; font-size: 30px; color: green;">
                    <span>Total:</span>
                    <span id="order-total">R$ {{ cart.get_total|floatformat:2 }}</span>
                  </div>
                </div>
                <div style="width: 100%; display: flex; justify-content: center;">
                  <button type="submit" class="confirm-btn">Confirmar Compra</button>
                </div>
              </div>
            </div>
          </form>
        {% else %} <!-- Caso não exista endereços -->

        {% endif %}
          <!-- RESUMO DO PEDIDO -->
          <div class="order-summary">
            <h2>Resumo do Pedido</h2>
            <div id="order-items">
              <table id="cart-table" class="table_itens" style="width: 100%;">
                <thead>
                  <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="cart-body" >
                  {% for item in cart.itens.all %}
                    <tr>
                      <td>
                        <div style="display: flex; flex-direction: row; align-items: center; justify-content: space-around">
                          <div>
                            <img src="{{item.product.photo.url}}" alt="{{item.name}}">
                          </div>
                          <div style="width: 50%;">
                            {{ item.product.name }}
                          </div>
                        </div>
                      </td>
                      <td>R$ {{ item.product.price|floatformat:2 }}</td>
                      <td>
                        <div style="display: flex; flex-direction: row; justify-content: space-evenly;">
                          <form action="{% url 'decrease_quantity' item.pk %}" method="post">
                            {% csrf_token %}
                            {% if item.quantity > 1 %}
                            <button type="submit"><strong>-</strong></button>
                            {% else %}
                            <button type="submit" onclick="return confirm('Tem certeza que deseja remover este item do carrinho?')">
                              <strong>-</strong>
                            </button>
      
                            {% endif %}
                          </form>
                          {{ item.quantity }}
                          <form action="{% url 'add_to_cart' item.product.pk %}" method="post">
                            {% csrf_token %}
                            <button type="submit"><strong>+</strong></button>
                          </form>
      
                        </div>
                      </td>
                      <td>R$ {{ item.get_subtotal|floatformat:2 }}</td>
                    </tr>
                      {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

      </div>
     
    {% else %} <!-- Caso não exista um carrinho ou itens  -->

      <div id="summary-items" class="order-summary">
        <h2>Resumo do Pedido</h2>
        <div id="order-items">
          <p>Seu carrinho está vazio.</p>
        </div>
        <div class="order-total">
          <span>Total:</span>
          <span id="order-total">R$ 0,00</span>
        </div>
      </div>

    {% endif %}
    
  </main>

{% endblock content %}